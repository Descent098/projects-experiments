<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICE demo</title>
    <style>
        *{
            padding:0;
            box-sizing: border-box;
            margin:0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        input{
            width:100%;
            border-radius:.6rem;
        }
        main{
            margin:0 auto;
            padding:2rem;
        }
        ul{
            padding:1rem;
            margin-left:1rem; 
        }
        fieldset{
            display: flex;
            border:none;
            gap:.2rem;
        }
        fieldset input{
            flex-basis:33%;
            padding:1rem;
            flex-grow: 1;
            
        }
        button{
            padding: .7rem 1.1rem;
            background-color:green;
            color:white;
            border-radius:.6rem;
            margin-top: .75rem;
            margin-bottom: .75rem;
        }
        @media (max-width:800px) {
            fieldset{
                flex-direction: column;
            }
            fieldset input{
                flex-basis:100%;
            }
        }
    </style>
</head>
    <main>
        <p>This page is a demo to show off connecting to an ice server, in this case 2 STUN servers: <ul><li>stun:stun1.l.google.com:19302</li><li>stun:stun.cloudflare.com:3478</li></ul></p>
        <button onclick="gather()">Gather</button>
        <hr>
        <h2>Results</h2>
        <output id="results"></output>
    </main>

<body>
    <script>
        
        function gather(){
            const iceServers = [
                {urls: "stun:stun1.l.google.com:19302", username: "", credential: ""},
                {urls: "stun:stun.cloudflare.com:3478", username:"", credential:""}
            ]
            const peerConnection = new RTCPeerConnection({iceServers})
            console.log("Initial peer connection", peerConnection)
            peerConnection.onicecandidate = handleNewCandidate
            peerConnection.onicegatheringstatechange = (e) => {handleStateChange(e, peerConnection)}
            peerConnection.createDataChannel("demo")
            console.log("Listeners established", peerConnection)
            peerConnection.createOffer().then(offer=>peerConnection.setLocalDescription(offer))
            console.log("Offer Created", peerConnection)

            // Post the SDP information after a 1 second delay
            setTimeout(() => {
                console.log(peerConnection)
                results.innerText += "\nSDP:\n" + peerConnection.localDescription.sdp;
            }, 1000);
        }

        /** A function to handle new ICE candidates
        *
        * @param {RTCPeerConnectionIceEvent} event
        **/
        function handleNewCandidate(event){
            if (event.candidate){
                results.innerText += `Candidate: ${JSON.stringify(event.candidate.candidate)}\n\n`
            } else{
                console.warn("Got no candidate from event", event)
            }
        }

        function handleStateChange(event, connection){
            console.log("State Change", connection)
            results.innerText += `Gathering state has changed: ${connection.iceGatheringState}\n\n`
        }

    </script>
    
</body>
</html>